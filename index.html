<!DOCTYPE html>
<html>

<head>
    <title>Registro de alumnos</title>
    <link rel="stylesheet" href="w3.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>

<body class="w3-content">
    <div justify-content="center" class="w3-container w3-center">
        <div class="w3-light-blue">
            <h2>Registrar alumno</h2>
        </div>
        <br>

        <form id="formRegistro">
            <label>Nombre:</label>
            <br>
            <input type="text" id="nombre" required>
            <br><br>

            <label>Calificacion:</label>
            <br>
            <input type="number" id="calif" required>
            <br><br>

            <button class="w3-button w3-green w3-hover-light-green w3-ripple">
                Guardar registro
            </button>
        </form>

        <div class="w3-light-blue">
            <h2>Tabla de registros</h2>
        </div>
        <br>

        <table class="w3-table-all w3-center" border="1" id="tablaRegistros">
            <thead>
                <tr class="w3-cyan">
                    <th>Nombre</th>
                    <th>Calificación</th>
                    <th>Acciones</th>
                </tr>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <br>
        <button class="w3-button w3-green w3-hover-light-green w3-ripple" onclick="descargarJSON()">Descargar
            JSON</button>

        <script>
            //  Configuración de Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyD4-zLL5XUx0L3CZN4e5FiuAGEuHKeQ8F4",
                authDomain: "registro-alumnos-156c9.firebaseapp.com",
                projectId: "registro-alumnos-156c9",
                storageBucket: "registro-alumnos-156c9.firebasestorage.app",
                messagingSenderId: "631143806444",
                appId: "1:631143806444:web:d927930fa7a52d8e63fcc9",
                measurementId: "G-9ZD9HY9VYS"
            };

            // Inicializar Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            let registros = [];

            // Cargar datos al iniciar la página
            async function cargarRegistros() {
                try {
                    const snapshot = await db.collection("alumnos").get();
                    registros = []; // Limpiar registros anteriores
                    snapshot.forEach(doc => {
                        // Se guarda el ID de Firestore para posible uso futuro (ej. borrar)
                        registros.push({ id: doc.id, ...doc.data() });
                    });
                    mostrarTabla();
                } catch (error) {
                    console.error("Error al cargar registros: ", error);
                }
            }

            async function guardarRegistro(nuevoAlumno) {
                try {
                    // Añadir el documento a la colección "alumnos"
                    const docRef = await db.collection("alumnos").add(nuevoAlumno);

                    // Añadir el alumno al array local con su ID de Firestore
                    registros.push({ id: docRef.id, nombre: nuevoAlumno.nombre, calif: nuevoAlumno.calif });

                    mostrarTabla();
                    alert("Registro guardado en Firestore con éxito!");

                } catch (error) {
                    console.error("Error al añadir documento: ", error);
                    alert("Error al guardar el registro.");
                }
            }

            async function borrarRegistro(id) {
                if (!confirm("¿Está seguro de que desea borrar este registro?")) {
                    return; // Detiene la función si el usuario cancela
                }

                try {
                    // Elimina el documento de Firestore
                    await db.collection("alumnos").doc(id).delete();

                    // Elimina el registro del array local 'registros'
                    registros = registros.filter(reg => reg.id !== id);

                    mostrarTabla();
                    alert("Registro borrado con éxito.");

                } catch (error) {
                    console.error("Error al borrar el registro: ", error);
                    alert("Error al intentar borrar el registro.");
                }
            }

            async function modificarRegistro(id, nuevoNombre, nuevaCalif) {
                try {
                    // Actualiza el documento en Firestore
                    await db.collection("alumnos").doc(id).update({
                        nombre: nuevoNombre,
                        calif: nuevaCalif
                    });

                    // Actualiza el registro en el array local 'registros'
                    const index = registros.findIndex(reg => reg.id === id);
                    if (index > -1) {
                        registros[index].nombre = nuevoNombre;
                        registros[index].calif = nuevaCalif;
                    }

                    mostrarTabla();
                    alert("Registro modificado con éxito.");

                } catch (error) {
                    console.error("Error al modificar el registro: ", error);
                    alert("Error al intentar modificar el registro.");
                }
            }

            function abrirMenuEdicion(id, nombreActual, califActual) {
                abrirMenuEdicion_Nombre(id, nombreActual, califActual);
                abrirMenuEdicion_Calif(id, nombreActual, califActual);
            }

            function abrirMenuEdicion_Nombre(id, nombreActual, califActual) {
                // Pedir el nuevo nombre
                const nuevoNombre = prompt(`Modificar nombre de ${nombreActual}:`, nombreActual);

                // Si el usuario cancela el nombre, detenemos la edición
                if (nuevoNombre === null || nuevoNombre.trim() === "") {
                    return;
                }

                // Llamar a la función de modificación
                modificarRegistro(id, nuevoNombre, califActual);
            }

            function abrirMenuEdicion_Calif(id, nombreActual, califActual) {
                // Pedir la nueva calificación
                let nuevaCalif;
                do {
                    const inputCalif = prompt(`Modificar calificación de ${nombreActual}:`, califActual);

                    // Si el usuario cancela la calificación
                    if (inputCalif === null) {
                        return;
                    }

                    nuevaCalif = parseFloat(inputCalif);
                    if (isNaN(nuevaCalif)) {
                        alert("Por favor, ingrese un número válido para la calificación.");
                    }

                } while (isNaN(nuevaCalif));

                // Llamar a la función de modificación
                modificarRegistro(id, nombreActual, nuevaCalif);
            }

            //  Funciones de Interfaz de Usuario

            function mostrarTabla() {
                const tbody = document.querySelector("#tablaRegistros tbody");
                tbody.innerHTML = "";

                registros.forEach(reg => {
                    const fila = `<tr>
                          <td class='w3-hover-light-blue w3-ripple' onclick="abrirMenuEdicion_Nombre('${reg.id}', '${reg.nombre}', '${reg.calif}')">${reg.nombre}</td>
                          <td class='w3-hover-light-blue w3-ripple' onclick="abrirMenuEdicion_Nombre('${reg.id}', '${reg.nombre}', '${reg.calif}')">${reg.calif}</td>
                          <td><button class="w3-button w3-red w3-round-large w3-tiny" onclick="event.stopPropagation(); borrarRegistro('${reg.id}')">Borrar</button></td>
                      </tr>`;
                    tbody.innerHTML += fila;
                });
            }

            function descargarJSON() {
                const blob = new Blob([JSON.stringify(registros, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = "registros.json";
                a.click();
            }

            //  Event Listeners y Arranque

            // Listener único para guardar el registro en Firebase
            document.getElementById("formRegistro").addEventListener("submit", function (e) {
                e.preventDefault();

                const nombre = document.getElementById("nombre").value;
                const calif = document.getElementById("calif").value;

                // Llama a la función que guarda en Firebase
                guardarRegistro({ nombre, calif });

                this.reset();
            });

            // Llamar a cargarRegistros() al final del script para iniciar la carga de datos
            cargarRegistros();

        </script>
    </div>

</body>

</html>
